name: ğŸš€ Deploy Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: 20.x
  CLOUDFRONT_DOMAIN: ${{ vars.CLOUDFRONT_DOMAIN }}
  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy to Production S3
    runs-on: ubuntu-latest
    environment: production

    # PRì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì•ˆ ì²´í¬
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: ğŸ“¥ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ” Quick validation
        run: |
          yarn tsc --noEmit
          yarn lint

      - name: ğŸ—ï¸ Build for production
        run: yarn build
        env:
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_APP_BUILD_TIME: ${{ github.event.head_commit.timestamp }}
          VITE_APP_ENVIRONMENT: production

      - name: ğŸ“Š Build summary
        run: |
          echo "## ğŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Size**: $(du -sh dist/ | cut -f1)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¤ Deploy to Production S3 (Preview Path)
        run: |
          # PR ë²ˆí˜¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ í”„ë¦¬ë·° ê²½ë¡œ ìƒì„±
          PREVIEW_PATH="pr-${{ github.event.number }}"
          echo "ğŸš€ Deploying to preview path: $PREVIEW_PATH"

          # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
          if [ -z "${{ env.S3_BUCKET_NAME }}" ]; then
            echo "âŒ S3_BUCKET_NAME is not set"
            exit 1
          fi

          echo "ğŸ“¦ S3 Bucket: ${{ env.S3_BUCKET_NAME }}"
          echo "ğŸ“ Preview Path: /$PREVIEW_PATH/"

          # Production S3ì— ì—…ë¡œë“œ (í”„ë¦¬ë·° ê²½ë¡œë¡œ)
          aws s3 sync dist/ s3://"${{ env.S3_BUCKET_NAME }}"/$PREVIEW_PATH/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --metadata-directive REPLACE
            
          # index.htmlì€ ìºì‹œ ì•ˆí•¨
          aws s3 cp dist/index.html s3://"${{ env.S3_BUCKET_NAME }}"/$PREVIEW_PATH/index.html \
            --cache-control "no-cache, no-store, must-revalidate" \
            --metadata-directive REPLACE
            
          echo "âœ… Deployment completed!"
          echo "ğŸ”— Preview URL: https://${{ env.CLOUDFRONT_DOMAIN }}/$PREVIEW_PATH/"

          # í™˜ê²½ë³€ìˆ˜ë¡œ URL ì €ì¥
          echo "PREVIEW_URL=https://${{ env.CLOUDFRONT_DOMAIN }}/$PREVIEW_PATH/" >> $GITHUB_ENV

      - name: ğŸ”„ Invalidate CloudFront cache
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."

          # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
          if [ -z "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "âŒ CLOUDFRONT_DISTRIBUTION_ID is not set"
            exit 1
          fi

          echo "ğŸ“‹ Distribution ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "ğŸ“ Invalidating path: /pr-${{ github.event.number }}/*"

          # í”„ë¦¬ë·° ê²½ë¡œì˜ ëª¨ë“  íŒŒì¼ ë¬´íš¨í™” (ì˜¬ë°”ë¥¸ í˜•ì‹)
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" \
            --invalidation-batch '{"Paths":{"Quantity":1,"Items":["/pr-${{ github.event.number }}/*"]},"CallerReference":"preview-${{ github.event.number }}-'$(date +%s)'"}' \
            --query 'Invalidation.Id' \
            --output text)
            
          echo "â³ Invalidation ID: $INVALIDATION_ID"
          echo "âœ… CloudFront cache invalidation initiated!"

      - name: ğŸ’¬ Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = process.env.PREVIEW_URL;

            const comment = `## ğŸš€ Preview Deployment

            âœ… **Successfully deployed to production environment!**

            ğŸ“± **Preview URL**: ${previewUrl}

            ### ğŸ“Š Deployment Details
            - **Commit**: \`${context.sha.slice(0, 7)}\`
            - **Branch**: \`${context.payload.pull_request.head.ref}\`
            - **Environment**: Production S3 + CloudFront
            - **Build Time**: \`${new Date().toISOString()}\`

            ### ğŸ”§ Actions Performed
            - âœ… Build completed
            - âœ… Deployed to production S3 (preview path)
            - âœ… CloudFront cache invalidated

            ---

            ğŸ”„ This preview will be updated automatically when you push new commits to this PR.
            ğŸ—‘ï¸ Preview will be cleaned up when the PR is merged or closed.`;

            // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );

            if (botComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // ìƒˆ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

  cleanup-on-close:
    name: ğŸ—‘ï¸ Cleanup Preview
    runs-on: ubuntu-latest
    environment: production
    if: github.event.action == 'closed'
    env:
      S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
      AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ—‘ï¸ Remove preview files from production S3
        run: |
          PREVIEW_PATH="pr-${{ github.event.number }}"
          echo "ğŸ—‘ï¸ Cleaning up preview: $PREVIEW_PATH"

          # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
          if [ -z "${{ env.S3_BUCKET_NAME }}" ]; then
            echo "âŒ S3_BUCKET_NAME is not set"
            exit 1
          fi

          echo "ğŸ“¦ S3 Bucket: ${{ env.S3_BUCKET_NAME }}"
          echo "ğŸ“ Removing path: /$PREVIEW_PATH/"

          aws s3 rm s3://"${{ env.S3_BUCKET_NAME }}"/$PREVIEW_PATH/ --recursive

          echo "âœ… Preview cleanup completed!"

      - name: ğŸ’¬ Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const comment = `## ğŸ—‘ï¸ Preview Cleaned Up

            âœ… **Preview deployment has been removed from production environment.**

            The preview files have been cleaned up from production S3 since this PR was ${context.payload.action}.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
