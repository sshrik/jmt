name: ðŸš€ Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: 18.x

jobs:
  deploy:
    name: ðŸ—ï¸ Build & Deploy Production
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: https://${{ secrets.CLOUDFRONT_DOMAIN }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: ðŸ“¥ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ” Pre-deploy validation
        run: |
          echo "ðŸ” Running pre-deployment checks..."
          yarn tsc --noEmit
          yarn lint
          echo "âœ… All checks passed!"

      - name: ðŸ—ï¸ Build for production
        run: yarn build
        env:
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_APP_BUILD_TIME: ${{ github.event.head_commit.timestamp }}
          VITE_APP_ENVIRONMENT: ${{ inputs.environment || 'production' }}

      - name: ðŸ“Š Build analysis
        run: |
          echo "## ðŸš€ Production Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $(git describe --tags --exact-match 2>/dev/null || echo 'No tag')" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Size**: $(du -sh dist/ | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Count**: $(find dist -type f | wc -l)" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ Build Contents" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸš€ Deploy to S3 Production
        run: |
          echo "ðŸš€ Deploying to production S3 bucket..."

          # S3ì— íŒŒì¼ ë™ê¸°í™” (ë£¨íŠ¸ ê²½ë¡œì—)
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE \
            --exclude "*.html"
            
          # HTML íŒŒì¼ì€ ë³„ë„ë¡œ ìºì‹œ ì„¤ì •
          find dist -name "*.html" -type f | while read file; do
            key=$(echo $file | sed 's|dist/||')
            aws s3 cp "$file" s3://${{ secrets.S3_BUCKET_NAME }}/$key \
              --cache-control "no-cache, no-store, must-revalidate" \
              --content-type "text/html" \
              --metadata-directive REPLACE
          done

          echo "âœ… Production deployment completed!"

      - name: ðŸ”„ Invalidate CloudFront cache
        run: |
          echo "ðŸ”„ Invalidating CloudFront cache for production..."

          # ì „ì²´ ìºì‹œ ë¬´íš¨í™”
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
            
          echo "â³ Invalidation ID: $INVALIDATION_ID"

          # ë¬´íš¨í™” ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          echo "â³ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID
            
          echo "âœ… CloudFront cache invalidation completed!"

      - name: ðŸ·ï¸ Create deployment tag
        if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          TAG_NAME="deploy-${TIMESTAMP}"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git tag -a $TAG_NAME -m "Production deployment on $TIMESTAMP"
          git push origin $TAG_NAME

          echo "ðŸ·ï¸ Created deployment tag: $TAG_NAME"

      - name: ðŸ“ Create deployment summary
        run: |
          echo "## ðŸŽ‰ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL**: https://${{ secrets.CLOUDFRONT_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "â° **Deployed at**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Actions Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployed to S3" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CloudFront cache invalidated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployment tag created" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” Slack notification (if configured)
        if: always() && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#deployments"
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ðŸš€ Production deployment ${{ job.status }}!
            Environment: ${{ inputs.environment || 'production' }}
            URL: https://${{ secrets.CLOUDFRONT_DOMAIN }}

  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: ðŸ¥ Check deployment health
        run: |
          echo "ðŸ¥ Performing health check..."

          # ê¸°ë³¸ ì ‘ê·¼ì„± ì²´í¬
          curl -f -s https://${{ secrets.CLOUDFRONT_DOMAIN }} > /dev/null

          # HTTP ìƒíƒœ ì½”ë“œ ì²´í¬
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.CLOUDFRONT_DOMAIN }})

          if [ $STATUS -eq 200 ]; then
            echo "âœ… Health check passed! (HTTP $STATUS)"
            echo "## ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Status**: Healthy (HTTP $STATUS)" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **URL**: https://${{ secrets.CLOUDFRONT_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health check failed! (HTTP $STATUS)"
            echo "## ðŸš¨ Health Check Results" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Status**: Unhealthy (HTTP $STATUS)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
